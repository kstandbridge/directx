// INCLUDES /////////////////////////////////////////////////////////////////////////////

// bell0bytes
#include "app.h"
#include "mainMenuState.h"
#include "gameCommands.h"
#include "inputHandler.h"
#include "playState.h"

// CLASS METHODS ////////////////////////////////////////////////////////////////////////
namespace UI
{
	/////////////////////////////////////////////////////////////////////////////////////////
	///////////////////////////// Constructor and Destructor ////////////////////////////////
	/////////////////////////////////////////////////////////////////////////////////////////
	MainMenuState::MainMenuState(core::DirectXApp* const app, std::wstring name) : GameState(app, name)
	{

	}

	MainMenuState::~MainMenuState()
	{

	}

	MainMenuState& MainMenuState::createInstance(core::DirectXApp* const app, std::wstring stateName)
	{
		static MainMenuState instance(app, stateName);
		return instance;
	}

	/////////////////////////////////////////////////////////////////////////////////////////
	/////////////////////////////// Initialization //////////////////////////////////////////
	/////////////////////////////////////////////////////////////////////////////////////////
	void MainMenuState::initialize()
	{
		// add to observer list of the input handler
		dxApp->addInputHandlerObserver(this);

		// position mouse at the center of the screen
		SetCursorPos(dxApp->getCurrentWidth() / 2, dxApp->getCurrentHeight() / 2);

		// hide the standard cursor
		ShowCursor(false);

		// allow mouse and keyboard input
		dxApp->activeMouse = true;
		dxApp->activeKeyboard = true;

		// create text formats
		d2d->createTextFormat(L"Segoe UI", 72.0f, mainMenuFormat);

		// create text layouts
		std::wstring menu = L"Main Menu";
		d2d->createTextLayoutFromWString(&menu, mainMenuFormat.Get(), (float)dxApp->getCurrentWidth(), 100, mainMenuLayout);
	}

	/////////////////////////////////////////////////////////////////////////////////////////
	///////////////////////////// Pause and Resume //////////////////////////////////////////
	/////////////////////////////////////////////////////////////////////////////////////////
	void MainMenuState::pause()
	{
		isPaused = true;
	}

	void MainMenuState::resume()
	{
		// allow mouse and keyboard input
		dxApp->activeMouse = true;
		dxApp->activeKeyboard = true;

		isPaused = false;
	}

	/////////////////////////////////////////////////////////////////////////////////////////
	/////////////////////////////// User Input //////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////////////////////////////
	util::Expected<bool> MainMenuState::onNotify(std::unordered_map<input::GameCommands, input::GameCommand&>& activeKeyMap)
	{
		if(!isPaused)
			return handleInput(activeKeyMap);

		// return success
		return true;
	}

	bool MainMenuState::handleInput(std::unordered_map<input::GameCommands, input::GameCommand&>& activeKeyMap)
	{
		// act on user input
		for (auto x : activeKeyMap)
		{
			switch (x.first)
			{
			case input::Start:
				// create game play state
				if (!dxApp->gameIsRunning)
					dxApp->changeGameState(&core::PlayState::createInstance(dxApp, L"Game"));
				else
					dxApp->popGameState();
				return false;

			case input::GameCommands::Quit:
				PostMessage(dxApp->getMainWindow(), WM_CLOSE, 0, 0);
				break;

			case input::GameCommands::ShowFPS:
				dxApp->showFPS = !dxApp->showFPS;
				break;
			}
		}

		return true;
	}

	/////////////////////////////////////////////////////////////////////////////////////////
	//////////////////////////////////// Update /////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////////////////////////////
	void MainMenuState::update(const double /*deltaTime*/)
	{

	}

	/////////////////////////////////////////////////////////////////////////////////////////
	/////////////////////////////////// Render //////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////////////////////////////
	void MainMenuState::render(const double /*farSeer*/)
	{
		d2d->printCenteredText(mainMenuLayout.Get());

		// print FPS information
		d2d->printFPS();
	}

	/////////////////////////////////////////////////////////////////////////////////////////
	/////////////////////////////// Shutdown ////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////////////////////////////
	void MainMenuState::shutdown()
	{
		// remove from the observer list
		dxApp->removeInputHandlerObserver(this);
	}
}